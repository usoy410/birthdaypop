rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Rules for rooms collection
     * - Anyone with the room code (document ID) can read room settings.
     * - Allows initialization and theme updates without Auth (keyed by room code).
     */
    match /rooms/{roomId} {
      allow get: if true;
      
      // Allow host to initialize or update the room settings
      allow create, update: if 
        (request.resource.data.keys().hasAny(['themeId', 'createdAt'])) &&
        (request.resource.data.get('themeId', '') is string) &&
        (request.resource.data.get('createdAt', null) == null || request.resource.data.get('createdAt', null) is timestamp);
      
      allow delete: if false;
    }

    /**
     * Rules for messages collection
     * - Anyone can read messages (queries are filtered by roomCode).
     * - Anyone can create a new 'wish' message.
     * - Host can mark messages as 'popped: true'.
     */
    match /messages/{messageId} {
      allow read: if true;

      allow create: if 
        request.resource.data.keys().hasAll(['roomCode', 'text', 'popped']) &&
        request.resource.data.roomCode is string &&
        request.resource.data.text is string &&
        request.resource.data.text.size() > 0 &&
        request.resource.data.popped == false &&
        (request.resource.data.get('createdAt', null) == null || request.resource.data.get('createdAt', null) is timestamp);

      // Only allow updating the 'popped' status (setting it to true)
      allow update: if 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['popped']) &&
        request.resource.data.popped == true;

      allow delete: if false;
    }
  }
}